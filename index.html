<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAHL Display - Amherst Adult Hockey League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: linear-gradient(135deg, #1a2a3a 0%, #0d1821 100%);
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(90deg, #1e3a5f 0%, #2a5a8f 100%);
            padding: 15px 30px;
            text-align: center;
            border-bottom: 3px solid #4a9eff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 0.9em;
            color: #a8d0ff;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header .last-updated {
            font-size: 0.65em;
            color: rgba(168, 208, 255, 0.7);
            margin-top: 3px;
        }

        .slides {
            flex: 1;
            position: relative;
            padding: 15px 25px 20px;
            overflow: hidden;
            min-height: 0;
        }

        .slide {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0;
            transform: translateY(35px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            pointer-events: none;
            min-height: 0;
            padding: 15px 25px 20px;
        }

        .slide.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .slide-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1.6fr 1.2fr;
            gap: 15px;
            min-height: 0;
        }

        .stacked-panels {
            display: grid;
            grid-template-rows: minmax(0, 1fr) minmax(0, 1fr);
            gap: 15px;
            min-height: 0;
        }

        .slide-scorers {
            justify-content: center;
        }

        .slide-scorers .scorers-panel {
            flex: 1;
        }

        .panel {
            background: rgba(20, 45, 70, 0.6);
            border: 1px solid rgba(74, 158, 255, 0.25);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(12px);
            overflow: hidden;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #4a9eff;
            padding: 12px 18px 10px;
            border-bottom: 1px solid rgba(74, 158, 255, 0.25);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .panel-body {
            flex: 1;
            padding: 12px 18px 18px;
            overflow-y: auto;
        }

        .scorers-panel .panel-body {
            padding: 10px 15px 15px;
            overflow: hidden;
        }

        .panel-body::-webkit-scrollbar {
            width: 10px;
        }

        .panel-body::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.35);
            border-radius: 5px;
        }

        .panel-body::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 158, 255, 0.55);
        }

        .results-panel .panel-body,
        .upcoming-panel .panel-body {
            padding: 10px 15px 15px;
        }

        /* Standings Table */
        .standings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 1em;
        }

        .standings-table thead {
            background: #2a5a8f;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .standings-table th,
        .standings-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
        }

        .standings-table th {
            font-weight: bold;
            font-size: 0.85em;
        }

        .standings-table tbody tr {
            background: rgba(42, 90, 143, 0.2);
            transition: background 0.3s;
        }

        .standings-table tbody tr:nth-child(even) {
            background: rgba(42, 90, 143, 0.1);
        }

        .standings-table tbody tr:hover {
            background: rgba(74, 158, 255, 0.2);
        }

        .standings-table .rank {
            font-weight: bold;
            color: #4a9eff;
            width: 40px;
        }

        .standings-table .points {
            font-weight: bold;
            color: #ffca28;
            font-size: 1.1em;
        }

        /* Scorers List */
        .scorers-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-template-rows: repeat(5, minmax(0, 1fr));
            grid-auto-flow: column;
            grid-auto-rows: minmax(0, 1fr);
            gap: 8px;
            margin-top: 5px;
            height: 100%;
        }

        .scorer-card {
            background: rgba(42, 90, 143, 0.3);
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 3px solid #4a9eff;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }

        .scorer-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(74, 158, 255, 0.4);
        }

        .scorer-rank {
            font-size: 1em;
            font-weight: bold;
            color: #ffca28;
            min-width: 28px;
            text-align: center;
        }

        .scorer-info {
            flex: 1;
            min-width: 0;
        }

        .scorer-name {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scorer-team {
            font-size: 0.65em;
            color: #a8d0ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scorer-points {
            font-size: 1.1em;
            font-weight: bold;
            color: #4a9eff;
        }

        .scorer-points .points-label {
            font-size: 0.5em;
            margin-left: 3px;
            color: #a8d0ff;
            letter-spacing: 1px;
        }

        .scorer-stats {
            font-size: 0.6em;
            color: #d0e6ff;
            margin-top: 2px;
            letter-spacing: 0.5px;
        }

        .streak-indicator {
            font-size: 0.7em;
            margin-left: 4px;
            vertical-align: middle;
        }

        .streak-hot {
            color: #ff6b6b;
        }

        .streak-cold {
            color: #74b9ff;
        }

        .leader-badge {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            font-size: 0.5em;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 4px;
            font-weight: bold;
        }

        .scorers-panel .panel-body::-webkit-scrollbar {
            display: none;
        }

        /* Results & Upcoming Games */
        .games-list {
            margin-top: 8px;
        }

        .game-card {
            background: rgba(42, 90, 143, 0.3);
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4a9eff;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .game-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(74, 158, 255, 0.4);
        }

        .game-date {
            font-size: 0.75em;
            color: #ffca28;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .results-panel .game-card {
            padding: 10px 12px;
            margin-bottom: 8px;
        }

        .results-panel .game-headline {
            font-size: 0.75em;
            margin-bottom: 6px;
        }

        .results-panel .game-date {
            font-size: 0.7em;
            margin-bottom: 6px;
        }

        .game-headline {
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e1efff;
            line-height: 1.3;
        }

        .game-matchup {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .team-name {
            font-weight: bold;
            flex: 1;
        }

        .game-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a9eff;
            margin: 0 15px;
        }

        .vs-text {
            color: #a8d0ff;
            margin: 0 15px;
            font-weight: normal;
        }

        .game-time {
            font-size: 0.75em;
            color: #a8d0ff;
            margin-top: 5px;
        }

        .game-location {
            font-size: 0.7em;
            color: #ffca28;
            margin-top: 3px;
        }

        .scoreboard {
            margin-bottom: 8px;
        }

        .score-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85em;
            padding: 3px 0;
        }

        .score-team {
            font-weight: 600;
            flex: 1;
        }

        .score-value {
            font-weight: 700;
            color: #ffca28;
            min-width: 35px;
            text-align: right;
        }

        .game-meta {
            font-size: 0.65em;
            color: #a8d0ff;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .game-meta a {
            color: #ffca28;
            text-decoration: none;
        }

        .game-meta a:hover {
            text-decoration: underline;
        }

        .team-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-wrapper {
            width: 28px;
            height: 28px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-wrapper.medium {
            width: 28px;
            height: 28px;
        }

        .logo-wrapper.small {
            width: 22px;
            height: 22px;
        }

        .logo-wrapper.large {
            width: 36px;
            height: 36px;
        }

        .team-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.45));
        }

        .logo-wrapper.small .team-logo {
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
        }

        .logo-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(74, 158, 255, 0.16);
            color: #ffca28;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: 1px solid rgba(255, 202, 40, 0.4);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
        }

        .logo-placeholder.small {
            font-size: 0.5em;
        }

        .logo-placeholder.medium {
            font-size: 0.6em;
        }

        .logo-placeholder.large {
            font-size: 0.75em;
        }

        .team-side {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .game-matchup-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .game-matchup-row .team-side {
            flex: 1;
        }

        .game-matchup-row .team-side:last-child {
            justify-content: flex-end;
            text-align: right;
        }

        .game-matchup-row .team-side span {
            font-weight: 600;
        }

        .game-matchup-row .vs-text {
            color: #a8d0ff;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .ticker {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 20px;
            background: linear-gradient(90deg, rgba(14, 31, 50, 0.95), rgba(12, 45, 72, 0.95));
            border-top: 2px solid rgba(74, 158, 255, 0.35);
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.4);
        }

        .ticker-label {
            font-size: 0.8em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffca28;
            white-space: nowrap;
        }

        .ticker-marquee {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        .ticker-track {
            display: inline-flex;
            align-items: center;
            gap: 60px;
            white-space: nowrap;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            animation: none;
            --ticker-shift: 0px;
        }

        .ticker-segment {
            display: flex;
            align-items: center;
            gap: 50px;
            font-size: 0.75em;
            letter-spacing: 0.5px;
            color: #d0e6ff;
        }

        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .ticker-label {
            color: #ffca28;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translate3d(0, 0, 0);
            }
            100% {
                transform: translate3d(calc(-1 * var(--ticker-shift)), 0, 0);
            }
        }

        .ticker-item.final {
            gap: 18px;
        }

        .ticker-text {
            font-size: 0.85em;
            color: #e1efff;
            font-weight: 600;
        }

        .ticker-performers {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #a8d0ff;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .ticker-performer {
            display: inline-flex;
            align-items: baseline;
            gap: 4px;
            white-space: nowrap;
        }

        .ticker-performer .label {
            color: #e1efff;
            font-weight: 600;
        }

        .ticker-performer .line {
            color: #a8d0ff;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .ticker-divider {
            color: rgba(208, 230, 255, 0.4);
            font-weight: 400;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1>Amherst Adult Hockey League</h1>
        <div class="subtitle">Live League Snapshot</div>
        <div class="last-updated" id="lastUpdated"></div>
    </div>

    <div class="slides">
        <div class="slide slide-main active">
            <div class="slide-grid">
                <div class="panel standings-panel">
                    <div class="panel-title">Standings</div>
                    <div class="panel-body">
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th class="rank">#</th>
                                    <th>Team</th>
                                    <th style="text-align: center;">Wins</th>
                                    <th style="text-align: center;">Losses</th>
                                    <th style="text-align: center;">Points</th>
                                </tr>
                            </thead>
                            <tbody id="standingsBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="stacked-panels">
                    <div class="panel results-panel">
                        <div class="panel-title">Recent Spotlight</div>
                        <div class="panel-body">
                            <div class="games-list" id="resultsList"></div>
                        </div>
                    </div>
                    <div class="panel upcoming-panel">
                        <div class="panel-title">Upcoming at Amherst Stadium</div>
                        <div class="panel-body">
                            <div class="games-list" id="upcomingList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="slide slide-scorers">
            <div class="panel scorers-panel">
                <div class="panel-title">Top 20 Scorers</div>
                <div class="panel-body">
                    <div class="scorers-grid" id="scorersGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="ticker">
        <div class="ticker-label">AAHL Ticker</div>
        <div class="ticker-marquee">
            <div class="ticker-track" id="tickerTrack"></div>
        </div>
    </div>

    <script>
        const SLIDE_DURATIONS_MS = [20000, 10000];
        const TICKER_PIXELS_PER_SECOND = 320;
        const TICKER_MIN_DURATION = 6;
        const EXTERNAL_SCORES_URL = null;
        const RESULTS_VISIBLE_COUNT = 1;
        const UPCOMING_VISIBLE_COUNT = 1;
        const RESULTS_ROTATION_MS = 5000;
        const UPCOMING_ROTATION_MS = 5000;
        let tickerExtras = [];
        let currentRecentGames = [];
        let currentUpcomingGames = [];
        let resultsIntervalId = null;
        let upcomingIntervalId = null;
        let recentCarouselIndex = 0;
        let upcomingCarouselIndex = 0;

        // Sample data with name corrections applied
        const sampleData = {
            standings: [
                { team: "Amherst Hawks", team_slug: "maltby-sports", wins: 8, losses: 2, points: 16 },
                { team: "Downtown Small", team_slug: "j-and-k-electric", wins: 7, losses: 3, points: 14 },
                { team: "Frontier City", team_slug: "gr-mitchell-welding", wins: 6, losses: 4, points: 12 },
                { team: "Maple Grove", team_slug: "ultramar", wins: 5, losses: 5, points: 10 },
                { team: "Ice Storm", team_slug: "colson-overhead-doors", wins: 4, losses: 6, points: 8 }
            ],
            top_scorers: [
                { rank: 1, name: "Issac Bridge", team: "Maltby Sports", team_slug: "maltby-sports", g: 12, a: 10, points: 22 },
                { rank: 2, name: "Marshall MacDonald", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 11, a: 9, points: 20 },
                { rank: 3, name: "Dave Atkinson", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 10, a: 8, points: 18 },
                { rank: 4, name: "Rubein Mackenzie", team: "J&K Electric", team_slug: "j-and-k-electric", g: 9, a: 9, points: 18 },
                { rank: 5, name: "Brendan Stone", team: "J&K Electric", team_slug: "j-and-k-electric", g: 9, a: 8, points: 17 },
                { rank: 6, name: "Thomas McCrossin", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 8, a: 8, points: 16 },
                { rank: 7, name: "Noah Perrin", team: "J&K Electric", team_slug: "j-and-k-electric", g: 7, a: 8, points: 15 },
                { rank: 8, name: "Ryan Budd", team: "J&K Electric", team_slug: "j-and-k-electric", g: 7, a: 7, points: 14 },
                { rank: 9, name: "Zack Gould", team: "Colson Overhead Doors", team_slug: "colson-overhead-doors", g: 7, a: 6, points: 13 },
                { rank: 10, name: "Logan Gesner", team: "Colson Overhead Doors", team_slug: "colson-overhead-doors", g: 6, a: 6, points: 12 },
                { rank: 11, name: "Ryan Macpherson", team: "J&K Electric", team_slug: "j-and-k-electric", g: 6, a: 6, points: 12 },
                { rank: 12, name: "Trevor Johnson", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 6, a: 5, points: 11 },
                { rank: 13, name: "Brad Linkletter", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 6, a: 5, points: 11 },
                { rank: 14, name: "Robichaud, Corey", team: "Colson Overhead Doors", team_slug: "colson-overhead-doors", g: 5, a: 6, points: 11 },
                { rank: 15, name: "Danny \"Biggie\" Small", team: "Maltby Sports", team_slug: "maltby-sports", g: 5, a: 6, points: 11 },
                { rank: 16, name: "Brodie Burke", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 5, a: 5, points: 10 },
                { rank: 17, name: "Tyler \"Tuffy\" Allen", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 4, a: 6, points: 10 },
                { rank: 18, name: "Jeremy Kinnear", team: "J&K Electric", team_slug: "j-and-k-electric", g: 6, a: 3, points: 9 },
                { rank: 19, name: "Nick Leopold", team: "J&K Electric", team_slug: "j-and-k-electric", g: 5, a: 4, points: 9 },
                { rank: 20, name: "Matt Cove", team: "G.R. Mitchell Welding", team_slug: "gr-mitchell-welding", g: 5, a: 4, points: 9 }
            ],
            recent_results: [
                {
                    datetime: "2025-11-02T21:00:00-04:00",
                    home: "Colson Overhead Doors",
                    away: "J&K Electric",
                    home_score: 3,
                    away_score: 6,
                    location: "Amherst",
                    home_line: { name: "Colson Overhead Doors", slug: "colson-overhead-doors" },
                    away_line: { name: "J&K Electric", slug: "j-and-k-electric" },
                    headline: "J&K Electric handles Colson Overhead Doors 6-3 driven by Brendan Stone's hat trick",
                    summary_url: "https://example.com/summary/3276449",
                    box_score_url: "https://example.com/box/3276449"
                },
                {
                    datetime: "2025-10-29T21:00:00-04:00",
                    home: "Maltby Sports",
                    away: "G.R. Mitchell Welding",
                    home_score: 10,
                    away_score: 2,
                    location: "Amherst",
                    home_line: { name: "Maltby Sports", slug: "maltby-sports" },
                    away_line: { name: "G.R. Mitchell Welding", slug: "gr-mitchell-welding" },
                    headline: "Maltby Sports routs G.R. Mitchell Welding 10-2 fueled by Thomas McCrossin's hat trick",
                    summary_url: "https://example.com/summary/3274302",
                    box_score_url: "https://example.com/box/3274302"
                },
                {
                    datetime: "2025-10-25T21:00:00-04:00",
                    home: "Ultramar",
                    away: "Maltby Sports",
                    home_score: 4,
                    away_score: 7,
                    location: "Amherst",
                    home_line: { name: "Ultramar", slug: "ultramar" },
                    away_line: { name: "Maltby Sports", slug: "maltby-sports" },
                    headline: "Maltby Sports outguns Ultramar 7-4 powered by Issac Bridge's 3G and 2A",
                    summary_url: "https://example.com/summary/3274296",
                    box_score_url: "https://example.com/box/3274296"
                }
            ],
            upcoming_games: [
                {
                    datetime: "2025-11-07T20:00:00-04:00",
                    time: "8:00 PM",
                    home: "Colson Overhead Doors",
                    away: "Ultramar",
                    location: "Amherst",
                    home_line: { name: "Colson Overhead Doors", slug: "colson-overhead-doors" },
                    away_line: { name: "Ultramar", slug: "ultramar" }
                },
                {
                    datetime: "2025-11-09T19:30:00-04:00",
                    time: "7:30 PM",
                    home: "G.R. Mitchell Welding",
                    away: "Maltby Sports",
                    location: "Amherst",
                    home_line: { name: "G.R. Mitchell Welding", slug: "gr-mitchell-welding" },
                    away_line: { name: "Maltby Sports", slug: "maltby-sports" }
                },
                {
                    datetime: "2025-11-12T20:00:00-04:00",
                    time: "8:00 PM",
                    home: "Ultramar",
                    away: "J&K Electric",
                    location: "Amherst",
                    home_line: { name: "Ultramar", slug: "ultramar" },
                    away_line: { name: "J&K Electric", slug: "j-and-k-electric" }
                }
            ]
        };

        const LOGO_BASE_URL = 'https://raw.githubusercontent.com/ThomasMcCrossin/aahlscraper/main/assets/logos/aahl';
        const TEAM_LOGOS = {
            'maltby-sports': `${LOGO_BASE_URL}/maltby-sports.png`,
            'j-and-k-electric': `${LOGO_BASE_URL}/j-and-k-electric.png`,
            'gr-mitchell-welding': `${LOGO_BASE_URL}/gr-mitchell-welding.png`,
            'colson-overhead-doors': `${LOGO_BASE_URL}/colson-overhead-doors.png`,
            'ultramar': `${LOGO_BASE_URL}/ultramar.svg`
        };

        const TEAM_SLUG_OVERRIDES = {
            'amherst hawks': 'maltby-sports',
            'downtown small': 'j-and-k-electric',
            'frontier city': 'gr-mitchell-welding',
            'maple grove': 'ultramar',
            'ice storm': 'colson-overhead-doors',
            'thunder bay': 'ultramar',
            'valley vipers': 'colson-overhead-doors',
            'g.r. mitchell welding': 'gr-mitchell-welding',
            'gr mitchell welding': 'gr-mitchell-welding',
            'j&k electric': 'j-and-k-electric',
            'j and k electric': 'j-and-k-electric'
        };

        function slugifyTeamName(name) {
            return (name || '')
                .toLowerCase()
                .replace(/&/g, ' and ')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function deriveInitials(name) {
            const words = (name || '')
                .split(/\s+/)
                .filter(Boolean)
                .map(word => word[0]);
            const initials = words.join('').slice(0, 3).toUpperCase();
            return initials || (name || 'AAHL').slice(0, 2).toUpperCase();
        }

        function resolveTeamVisual(name, slug) {
            const cleanName = correctName(name || 'Team');
            const baseSlug = (slug || '').toLowerCase() || slugifyTeamName(cleanName);
            const overrideSlug = TEAM_SLUG_OVERRIDES[cleanName.toLowerCase()] || TEAM_SLUG_OVERRIDES[baseSlug] || baseSlug;
            const logo = TEAM_LOGOS[overrideSlug] || null;
            return {
                name: cleanName,
                slug: overrideSlug,
                logo,
                initials: deriveInitials(cleanName)
            };
        }

        function teamLogoHtml(info, size = 'medium') {
            const sizeClass = size === 'small' || size === 'large' ? size : 'medium';
            const imgHtml = info.logo
                ? `<img src="${info.logo}" class="team-logo ${sizeClass}" alt="${info.name} logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                : `<img class="team-logo ${sizeClass}" style="display:none;" alt="">`;
            const placeholderDisplay = info.logo ? 'style="display:none;"' : '';
            return `
                <div class="logo-wrapper ${sizeClass}">
                    ${imgHtml}
                    <div class="logo-placeholder ${sizeClass}" ${placeholderDisplay}>${info.initials}</div>
                </div>
            `;
        }

        // Name correction function
        function correctName(name) {
            if (!name) return name;
            let transformed = String(name);
            transformed = transformed.replace(/Meathead/gi, 'Marshall');
            transformed = transformed.replace(/Mccrossin/gi, 'McCrossin');
            transformed = transformed.replace(/Danny\s*"?Biggie"?\s*Small/gi, 'Biggie Small');
            transformed = transformed.replace(/Biggie\s+"?Small"?/gi, 'Biggie Small');
            transformed = transformed.replace(/Rubein/gi, 'Reuben');
            return transformed;
        }

        // Apply name corrections to data
        function correctDataNames(data) {
            const clone = { ...data };

            if (Array.isArray(data.top_scorers)) {
                clone.top_scorers = data.top_scorers.map((scorer, index) => {
                    const rawName = scorer.name || scorer.player_name || '';
                    const name = formatPlayerDisplayName(correctName(rawName));
                    const team = scorer.team_name || scorer.team || '';
                    const goals = Number(scorer.g ?? scorer.goals ?? scorer.Goals ?? 0) || 0;
                    const assists = Number(scorer.a ?? scorer.assists ?? scorer.Assists ?? 0) || 0;
                    const points = Number(scorer.points ?? scorer.pts ?? (goals + assists)) || (goals + assists);
                    return {
                        ...scorer,
                        name,
                        player_name: name,
                        team: team,
                        team_name: team,
                        rank: scorer.rank || index + 1,
                        g: goals,
                        a: assists,
                        points
                    };
                });
            }

            if (Array.isArray(data.recent_results)) {
                clone.recent_results = data.recent_results.map(game => {
                    const homeLine = game.home_line ? { ...game.home_line, name: correctName(game.home_line.name) } : game.home_line;
                    const awayLine = game.away_line ? { ...game.away_line, name: correctName(game.away_line.name) } : game.away_line;
                    const playerStats = {};
                    if (game.player_stats) {
                        ['home', 'away'].forEach(side => {
                            if (Array.isArray(game.player_stats[side])) {
                                playerStats[side] = game.player_stats[side].map(player => ({
                                    ...player,
                                    name: formatPlayerDisplayName(correctName(player.name || player.player_name)),
                                    goals: Number(player.goals ?? player.g ?? 0) || 0,
                                    assists: Number(player.assists ?? player.a ?? 0) || 0,
                                    points: Number(player.points ?? player.pts ?? ((Number(player.goals ?? player.g ?? 0) || 0) + (Number(player.assists ?? player.a ?? 0) || 0))) || 0,
                                }));
                            }
                        });
                    }
                    return {
                        ...game,
                        home: formatPlayerDisplayName(correctName(game.home || game.home_team || '')),
                        away: formatPlayerDisplayName(correctName(game.away || game.away_team || '')),
                        home_line: homeLine,
                        away_line: awayLine,
                        headline: game.headline ? correctName(game.headline) : game.headline,
                        player_stats: Object.keys(playerStats).length ? playerStats : game.player_stats,
                    };
                });
            }

            if (Array.isArray(data.upcoming_games)) {
                clone.upcoming_games = data.upcoming_games.map(game => ({
                    ...game,
                    home: formatPlayerDisplayName(correctName(game.home || game.home_team || '')),
                    away: formatPlayerDisplayName(correctName(game.away || game.away_team || ''))
                }));
            }

            return clone;
        }

        function formatPlayerDisplayName(rawName) {
            let clean = correctName(rawName || '').trim();
            if (clean.includes(',')) {
                const [last, first] = clean.split(',').map(part => part.trim()).filter(Boolean);
                clean = `${first || ''} ${last || ''}`.trim();
            }
            clean = correctName(clean);
            return clean.replace(/\s+/g, ' ');
        }

        function formatStatLine(stat) {
            if (!stat) return '';
            const goals = Number(stat.goals ?? stat.g ?? 0) || 0;
            const assists = Number(stat.assists ?? stat.a ?? 0) || 0;
            const points = Number(stat.points ?? stat.pts ?? (goals + assists)) || (goals + assists);
            if (!goals && !assists && !points) return '';

            const parts = [];
            if (goals) parts.push(`${goals}G`);
            if (assists) parts.push(`${assists}A`);
            if (!parts.length) parts.push(`${points}P`);
            return parts.join(' ');
        }

        function extractGamePerformers(game, limit = 5) {
            if (!game || !game.player_stats) return [];

            const collected = [];
            ['home', 'away'].forEach(side => {
                const roster = game.player_stats?.[side];
                if (!Array.isArray(roster)) return;
                roster.forEach(entry => {
                    if (!entry) return;
                    const name = formatPlayerDisplayName(entry.name || entry.player_name);
                    if (!name) return;
                    const goals = Number(entry.goals ?? entry.g ?? 0) || 0;
                    const assists = Number(entry.assists ?? entry.a ?? 0) || 0;
                    const points = Number(entry.points ?? entry.pts ?? (goals + assists)) || (goals + assists);
                    const statLine = formatStatLine({ goals, assists, points });
                    if (!statLine) return;
                    collected.push({
                        name,
                        statLine,
                        points,
                        goals,
                        assists,
                    });
                });
            });

            collected.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goals !== a.goals) return b.goals - a.goals;
                if (b.assists !== a.assists) return b.assists - a.assists;
                return a.name.localeCompare(b.name);
            });

            return collected.slice(0, limit).map(item => ({
                name: item.name,
                statLine: item.statLine,
            }));
        }

        function getCycledSlice(items, start, count) {
            if (!Array.isArray(items) || items.length === 0) return [];
            const normalizedStart = ((start % items.length) + items.length) % items.length;
            const result = [];
            const limit = Math.min(count, items.length);
            for (let i = 0; i < limit; i++) {
                result.push(items[(normalizedStart + i) % items.length]);
            }
            return result;
        }

        const DAY_MS = 24 * 60 * 60 * 1000;
        const CACHE_KEY = 'aahl_display_cache_v1';
        const CACHE_TTL_MS = 24 * DAY_MS;

        function saveCache(data) {
            try {
                const payload = {
                    saved_at: new Date().toISOString(),
                    data,
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
            } catch (err) {
                console.warn('Unable to save cache', err);
            }
        }

        function loadCache() {
            try {
                const raw = localStorage.getItem(CACHE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !parsed.data) return null;
                const savedAt = new Date(parsed.saved_at || 0);
                if (Number.isNaN(savedAt.getTime())) return null;
                const age = Date.now() - savedAt.getTime();
                if (age > CACHE_TTL_MS) {
                    console.log('Cached data is older than 24h, ignoring.');
                    return null;
                }
                return parsed.data;
            } catch (err) {
                console.warn('Unable to read cache', err);
                return null;
            }
        }

        // Format date
        function formatDate(value) {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value || '';
            }
            const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function parseGameDate(game) {
            if (!game) return null;
            const candidates = [game.datetime, game.start_local, game.start_utc, game.date];
            for (const candidate of candidates) {
                if (!candidate) continue;
                const parsed = new Date(candidate);
                if (!Number.isNaN(parsed.getTime())) {
                    return parsed;
                }
            }
            return null;
        }

        function filterRecentGames(games, days = 7) {
            const now = new Date();
            const cutoff = new Date(now.getTime() - days * DAY_MS);
            return games
                .map(game => ({ game, date: parseGameDate(game) }))
                .filter(item => item.date && item.date <= now && item.date >= cutoff)
                .sort((a, b) => b.date - a.date)
                .slice(0, 8)
                .map(item => item.game);
        }

        function filterUpcomingGames(games, days = 7) {
            const now = new Date();
            const horizon = new Date(now.getTime() + days * DAY_MS);
            return games
                .map(game => ({ game, date: parseGameDate(game) }))
                .filter(item => item.date && item.date >= now && item.date <= horizon)
                .sort((a, b) => a.date - b.date)
                .slice(0, 8)
                .map(item => item.game);
        }

        function gameIdentifier(game) {
            if (game.game_id) return `id:${game.game_id}`;
            const home = (game.home || game.home_team || '').toLowerCase();
            const away = (game.away || game.away_team || '').toLowerCase();
            const date = game.datetime || game.start_local || game.start_utc || game.date || '';
            return `${home}|${away}|${date}`;
        }

        function uniqueByGameId(games) {
            const seen = new Set();
            return games.filter(game => {
                const key = gameIdentifier(game);
                if (!key) return true;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function formatTimeDisplay(game) {
            if (game.time) return game.time;
            const date = parseGameDate(game);
            if (!date) return 'TBD';
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function formatRelative(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
            const now = new Date();
            const diffDays = Math.round((date - now) / DAY_MS);
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays === -1) return 'Yesterday';
            if (diffDays > 1) return `In ${diffDays} days`;
            return `${Math.abs(diffDays)} days ago`;
        }

        // Render standings
        function renderStandings(standings) {
            const tbody = document.getElementById('standingsBody');
            tbody.innerHTML = '';
            standings.forEach((team, index) => {
                const info = resolveTeamVisual(team.team || team.team_name || '', team.team_slug || team.teamSlug);
                const wins = Number(team.wins ?? team.Wins ?? team.win ?? 0) || 0;
                const losses = Number(team.losses ?? team.Losses ?? team.loss ?? 0) || 0;
                const points = Number(team.points ?? team.Points ?? team.pts ?? 0) || 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="rank">${index + 1}</td>
                    <td>
                        <div class="team-cell">
                            ${teamLogoHtml(info, 'small')}
                            <span>${info.name}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${wins}</td>
                    <td style="text-align: center;">${losses}</td>
                    <td class="points" style="text-align: center;">${points}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render top scorers
        function renderScorers(scorers) {
            const grid = document.getElementById('scorersGrid');
            grid.innerHTML = '';
            const sorted = (Array.isArray(scorers) ? [...scorers] : []).sort((a, b) => {
                const rankA = Number(a?.rank ?? Infinity);
                const rankB = Number(b?.rank ?? Infinity);
                if (rankA !== rankB) return rankA - rankB;
                const pointsA = Number(a?.points ?? a?.pts ?? a?.Points ?? 0);
                const pointsB = Number(b?.points ?? b?.pts ?? b?.Points ?? 0);
                return pointsB - pointsA;
            });
            sorted
                .slice(0, 20)
                .forEach((scorer, index) => {
                    const rank = scorer.rank || index + 1;
                    const name = correctName(scorer.name || scorer.player_name || `Player ${rank}`);
                    const team = scorer.team_name || scorer.team || '';
                    const teamInfo = resolveTeamVisual(team, scorer.team_slug || scorer.teamSlug);
                    const goals = Number(scorer.g ?? scorer.goals ?? scorer.Goals ?? 0) || 0;
                    const assists = Number(scorer.a ?? scorer.assists ?? scorer.Assists ?? 0) || 0;
                    const points = Number(scorer.points ?? scorer.pts ?? (goals + assists)) || (goals + assists);

                    // Build streak indicator
                    let streakHtml = '';
                    const hotStreak = Number(scorer.hot_streak ?? 0);
                    const coldStreak = Number(scorer.cold_streak ?? 0);
                    if (hotStreak >= 3) {
                        streakHtml = `<span class="streak-indicator streak-hot" title="${hotStreak} game goal streak">üî•${hotStreak}</span>`;
                    } else if (hotStreak >= 2) {
                        streakHtml = `<span class="streak-indicator streak-hot" title="${hotStreak} game goal streak">üî•</span>`;
                    } else if (coldStreak >= 3) {
                        streakHtml = `<span class="streak-indicator streak-cold" title="${coldStreak} games without a goal">‚ùÑÔ∏è</span>`;
                    }

                    // Leader badge for top 3
                    const leaderBadge = rank <= 3 ? `<span class="leader-badge">${rank === 1 ? '1ST' : rank === 2 ? '2ND' : '3RD'}</span>` : '';

                    const card = document.createElement('div');
                    card.className = 'scorer-card';
                    card.innerHTML = `
                        <div class="scorer-rank">#${rank}</div>
                        ${teamLogoHtml(teamInfo, 'small')}
                        <div class="scorer-info">
                            <div class="scorer-name">${name}${streakHtml}${leaderBadge}</div>
                            <div class="scorer-team">${teamInfo.name}</div>
                            <div class="scorer-stats">${goals} G ¬∑ ${assists} A</div>
                        </div>
                        <div class="scorer-points">${points}<span class="points-label">PTS</span></div>
                    `;
                    grid.appendChild(card);
                });
        }

        // Render recent results
        function renderResults(results, startIndex = 0) {
            const list = document.getElementById('resultsList');
            list.innerHTML = '';
            if (!results || results.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #a8d0ff;">No recent results available</div>';
                return;
            }

            const subset = getCycledSlice(results, startIndex, RESULTS_VISIBLE_COUNT);
            subset.forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';

                const dateObj = parseGameDate(game);
                const dateLine = dateObj ? formatDate(dateObj) : formatDate(game.date || '');
                const relative = dateObj ? formatRelative(dateObj) : '';
                const headline = game.headline ? correctName(game.headline) : `${game.away || 'Away'} vs ${game.home || 'Home'}`;
                const awayTeam = correctName(game.away || game.away_team || 'Away');
                const homeTeam = correctName(game.home || game.home_team || 'Home');
                const awayScore = game.away_score ?? (game.result ? String(game.result).split('-')[0].trim() : '');
                const homeScore = game.home_score ?? (game.result ? String(game.result).split('-')[1].trim() : '');
                const location = game.location || 'Amherst';
                const awayInfo = resolveTeamVisual(awayTeam, game.away_line?.slug || game.away_line?.team_slug || game.away_team_slug);
                const homeInfo = resolveTeamVisual(homeTeam, game.home_line?.slug || game.home_line?.team_slug || game.home_team_slug);

                card.innerHTML = `
                    <div class="game-date">${relative ? `${dateLine} ¬∑ ${relative}` : dateLine}</div>
                    <div class="game-headline">${headline}</div>
                    <div class="scoreboard">
                        <div class="score-row">
                            ${teamLogoHtml(awayInfo, 'small')}
                            <span class="score-team">${awayInfo.name}</span>
                            <span class="score-value">${awayScore}</span>
                        </div>
                        <div class="score-row">
                            ${teamLogoHtml(homeInfo, 'small')}
                            <span class="score-team">${homeInfo.name}</span>
                            <span class="score-value">${homeScore}</span>
                        </div>
                    </div>
                    <div class="game-meta">Location: ${location}</div>
                `;
                list.appendChild(card);
            });

        }

        // Render upcoming games
        function renderUpcoming(games, startIndex = 0) {
            const list = document.getElementById('upcomingList');
            list.innerHTML = '';
            if (!games || games.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #a8d0ff;">No upcoming games available</div>';
                return;
            }
            const subset = getCycledSlice(games, startIndex, UPCOMING_VISIBLE_COUNT);
            subset.forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';
                const dateObj = parseGameDate(game);
                const dateLine = dateObj ? formatDate(dateObj) : formatDate(game.date || 'Upcoming');
                const relative = dateObj ? formatRelative(dateObj) : '';
                const awayTeam = correctName(game.away || game.away_team || 'Away');
                const homeTeam = correctName(game.home || game.home_team || 'Home');
                const awayInfo = resolveTeamVisual(awayTeam, game.away_line?.slug || game.away_line?.team_slug || game.away_team_slug);
                const homeInfo = resolveTeamVisual(homeTeam, game.home_line?.slug || game.home_line?.team_slug || game.home_team_slug);
                const timeText = formatTimeDisplay(game);
                const location = game.location || 'Amherst';
                card.innerHTML = `
                    <div class="game-date">${relative ? `${dateLine} ¬∑ ${relative}` : dateLine}</div>
                    <div class="game-matchup-row">
                        <div class="team-side">
                            ${teamLogoHtml(awayInfo, 'small')}
                            <span>${awayInfo.name}</span>
                        </div>
                        <div class="vs-text">@</div>
                        <div class="team-side" style="justify-content: flex-end;">
                            ${teamLogoHtml(homeInfo, 'small')}
                            <span>${homeInfo.name}</span>
                        </div>
                    </div>
                    <div class="game-meta">Time: ${timeText} ¬∑ Location: ${location}</div>
                `;
                list.appendChild(card);
            });

        }

        function renderTicker(recentGames, upcomingGames, scorers = [], standings = []) {
            const track = document.getElementById('tickerTrack');
            if (!track) return;

            track.style.animation = 'none';
            track.style.transform = 'translate3d(0, 0, 0)';
            track.style.setProperty('--ticker-shift', '0px');

            const entries = [];
            const seenKeys = new Set();

            // Add league leaders
            if (scorers && scorers.length > 0) {
                // Points leader
                const pointsLeader = scorers[0];
                if (pointsLeader) {
                    const name = pointsLeader.name || pointsLeader.player_name || 'Unknown';
                    const pts = Number(pointsLeader.points ?? 0);
                    entries.push(`<div class="ticker-item"><span class="ticker-label">Points Leader</span><span class="ticker-text">${name} (${pts} pts)</span></div>`);
                }

                // Goals leader
                const goalsLeader = [...scorers].sort((a, b) => {
                    const goalsA = Number(a.g ?? a.goals ?? 0);
                    const goalsB = Number(b.g ?? b.goals ?? 0);
                    return goalsB - goalsA;
                })[0];
                if (goalsLeader) {
                    const name = goalsLeader.name || goalsLeader.player_name || 'Unknown';
                    const goals = Number(goalsLeader.g ?? goalsLeader.goals ?? 0);
                    entries.push(`<div class="ticker-item"><span class="ticker-label">Goals Leader</span><span class="ticker-text">${name} (${goals} G)</span></div>`);
                }

                // Assists leader
                const assistsLeader = [...scorers].sort((a, b) => {
                    const assistsA = Number(a.a ?? a.assists ?? 0);
                    const assistsB = Number(b.a ?? b.assists ?? 0);
                    return assistsB - assistsA;
                })[0];
                if (assistsLeader) {
                    const name = assistsLeader.name || assistsLeader.player_name || 'Unknown';
                    const assists = Number(assistsLeader.a ?? assistsLeader.assists ?? 0);
                    entries.push(`<div class="ticker-item"><span class="ticker-label">Assists Leader</span><span class="ticker-text">${name} (${assists} A)</span></div>`);
                }

                // Hot streaks
                const hotPlayers = scorers.filter(s => Number(s.hot_streak ?? 0) >= 3);
                if (hotPlayers.length > 0) {
                    const hotNames = hotPlayers.slice(0, 2).map(p => {
                        const name = p.name || p.player_name || 'Unknown';
                        return `${name} (${p.hot_streak}G streak)`;
                    }).join(', ');
                    entries.push(`<div class="ticker-item"><span class="ticker-label">üî• Hot</span><span class="ticker-text">${hotNames}</span></div>`);
                }
            }

            // Add standings leader
            if (standings && standings.length > 0) {
                const leader = standings[0];
                const teamName = leader.team || leader.team_name || 'Unknown';
                const pts = Number(leader.points ?? 0);
                const wins = Number(leader.wins ?? 0);
                const losses = Number(leader.losses ?? 0);
                entries.push(`<div class="ticker-item"><span class="ticker-label">1st Place</span><span class="ticker-text">${teamName} (${wins}-${losses}, ${pts} pts)</span></div>`);
            }

            function tickerKey(game, type) {
                const idPart = String(game?.game_id ?? game?.id ?? '').trim();
                const dtPart = String(game?.datetime ?? game?.start_local ?? game?.start_utc ?? game?.date ?? '').trim();
                const awayPart = correctName(game?.away || game?.away_team || '');
                const homePart = correctName(game?.home || game?.home_team || '');
                const composite = idPart || `${awayPart}|${homePart}|${dtPart}`;
                return `${type}|${composite}`.toLowerCase();
            }

            function addEntry(game, type, html) {
                const key = tickerKey(game, type);
                if (!key || seenKeys.has(key)) return;
                seenKeys.add(key);
                entries.push(html);
            }

            function addExtraEntry(label, text, meta = {}) {
                const cleanLabel = (label || 'Update').toString();
                const cleanText = (text || '').toString();
                if (!cleanText) return;
                const key = `external|${cleanLabel}|${cleanText}`.toLowerCase();
                if (seenKeys.has(key)) return;
                seenKeys.add(key);
                const badge = meta.badge ? `<span class="ticker-label">${meta.badge}</span>` : `<span class="ticker-label">${cleanLabel}</span>`;
                entries.push(`<div class="ticker-item">${badge}<span class="ticker-text">${cleanText}</span></div>`);
            }

            (recentGames || []).forEach(game => {
                const away = correctName(game.away || game.away_team || 'Away');
                const home = correctName(game.home || game.home_team || 'Home');
                const awayScore = game.away_score ?? (game.result ? String(game.result).split('-')[0].trim() : '');
                const homeScore = game.home_score ?? (game.result ? String(game.result).split('-')[1].trim() : '');
                if (awayScore === '' && homeScore === '') return;
                const scoreLine = `${away} ${awayScore}-${homeScore} ${home}`;
                const performers = extractGamePerformers(game, 5);
                const performerHtml = performers.length
                    ? `<span class="ticker-performers">${performers.map((entry, index) => {
                        const divider = index === performers.length - 1 ? '' : '<span class="ticker-divider">|</span>';
                        return `<span class="ticker-performer"><span class="label">${entry.name}</span><span class="line">${entry.statLine}</span></span>${divider}`;
                    }).join('')}</span>`
                    : '';
                addEntry(
                    game,
                    'final',
                    `<div class="ticker-item final"><span class="ticker-label">Final</span><span class="ticker-text">${scoreLine}</span>${performerHtml}</div>`
                );
            });

            (upcomingGames || []).forEach(game => {
                const dateObj = parseGameDate(game);
                const dateLine = dateObj
                    ? dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                    : (game.date || '');
                const away = correctName(game.away || game.away_team || 'Away');
                const home = correctName(game.home || game.home_team || 'Home');
                const timeText = formatTimeDisplay(game);
                const location = game.location || 'Amherst';
                addEntry(
                    game,
                    'upcoming',
                    `<div class="ticker-item"><span class="ticker-label">Next</span><span class="ticker-text">${dateLine} ${timeText} ${away} @ ${home} (${location})</span></div>`
                );
            });

            (tickerExtras || []).forEach(extra => {
                if (!extra) return;
                addExtraEntry(extra.label || extra.source || 'Update', extra.text || extra.summary || '', extra.meta || {});
            });

            if (entries.length === 0) {
                const placeholder = '<div class="ticker-item">AAHL updates will appear here soon.</div>';
                track.innerHTML = `<div class="ticker-segment">${placeholder}</div><div class="ticker-segment">${placeholder}</div>`;
                track.style.animation = 'none';
                return;
            }

            if (entries.length > 0) {
                const segmentHtml = entries.join('');
                track.innerHTML = `
                    <div class="ticker-segment">${segmentHtml}</div>
                    <div class="ticker-segment">${segmentHtml}</div>
                `;
            }

            const firstSegment = track.querySelector('.ticker-segment');
            if (!firstSegment) {
                track.style.animation = 'none';
                return;
            }

            const segmentWidth = firstSegment.getBoundingClientRect().width;
            if (!segmentWidth || !Number.isFinite(segmentWidth)) {
                track.style.animation = 'none';
                return;
            }

            const duration = Math.max(TICKER_MIN_DURATION, segmentWidth / TICKER_PIXELS_PER_SECOND);
            track.style.setProperty('--ticker-shift', `${segmentWidth}px`);
            track.style.animationName = 'ticker-scroll';
            track.style.animationDuration = `${duration}s`;
            track.style.animationTimingFunction = 'linear';
            track.style.animationIterationCount = 'infinite';
            track.style.animationPlayState = 'running';
        }

        function startResultsCarousel(resetIndex = true) {
            if (resultsIntervalId) {
                clearInterval(resultsIntervalId);
                resultsIntervalId = null;
            }

            if (!currentRecentGames.length) {
                renderResults([]);
                return;
            }

            if (resetIndex || recentCarouselIndex >= currentRecentGames.length) {
                recentCarouselIndex = 0;
            }
            renderResults(currentRecentGames, recentCarouselIndex);

            if (currentRecentGames.length > RESULTS_VISIBLE_COUNT) {
                resultsIntervalId = setInterval(() => {
                    recentCarouselIndex = (recentCarouselIndex + RESULTS_VISIBLE_COUNT) % currentRecentGames.length;
                    renderResults(currentRecentGames, recentCarouselIndex);
                }, RESULTS_ROTATION_MS);
            }
        }

        function startUpcomingCarousel(resetIndex = true) {
            if (upcomingIntervalId) {
                clearInterval(upcomingIntervalId);
                upcomingIntervalId = null;
            }

            if (!currentUpcomingGames.length) {
                renderUpcoming([]);
                return;
            }

            if (resetIndex || upcomingCarouselIndex >= currentUpcomingGames.length) {
                upcomingCarouselIndex = 0;
            }
            renderUpcoming(currentUpcomingGames, upcomingCarouselIndex);

            if (currentUpcomingGames.length > UPCOMING_VISIBLE_COUNT) {
                upcomingIntervalId = setInterval(() => {
                    upcomingCarouselIndex = (upcomingCarouselIndex + UPCOMING_VISIBLE_COUNT) % currentUpcomingGames.length;
                    renderUpcoming(currentUpcomingGames, upcomingCarouselIndex);
                }, UPCOMING_ROTATION_MS);
            }
        }

        function formatExternalTickerData(feeds) {
            if (!feeds || typeof feeds !== 'object') return [];
            const entries = [];

            const processGames = (games, label) => {
                if (!Array.isArray(games)) return;
                games.forEach(game => {
                    if (!game) return;
                    const away = correctName(game.away || game.away_team || 'Away');
                    const home = correctName(game.home || game.home_team || 'Home');
                    const awayScore = game.away_score ?? game.awayPoints ?? game.score_away ?? '';
                    const homeScore = game.home_score ?? game.homePoints ?? game.score_home ?? '';
                    const status = (game.status || game.game_status || '').replace(/\s+/g, ' ').trim();
                    const suffix = status ? ` (${status})` : '';
                    const text = `${away} ${awayScore} - ${homeScore} ${home}${suffix}`.trim();
                    entries.push({
                        label: label || 'Update',
                        text,
                        meta: game.meta || {},
                    });
                });
            };

            Object.entries(feeds).forEach(([key, value]) => {
                if (key === 'games' || key === 'extra') return;
                if (!Array.isArray(value)) return;
                const label = key.toUpperCase();
                processGames(value, label);
            });

            if (Array.isArray(feeds.games)) {
                processGames(feeds.games, feeds.label || 'Update');
            }

            if (Array.isArray(feeds.extra)) {
                feeds.extra.forEach(item => {
                    if (!item || !item.text) return;
                    entries.push({
                        label: item.label || item.source || 'Update',
                        text: item.text,
                        meta: item.meta || {},
                    });
                });
            }

            return entries;
        }

        function loadTickerExtras() {
            if (!EXTERNAL_SCORES_URL) {
                tickerExtras = [];
                return Promise.resolve();
            }

            return fetch(EXTERNAL_SCORES_URL, { cache: 'no-store' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch external ticker feeds');
                    }
                    return response.json();
                })
                .then(data => {
                    tickerExtras = formatExternalTickerData(data);
                    if (currentRecentGames.length || currentUpcomingGames.length) {
                        renderTicker(currentRecentGames, currentUpcomingGames);
                    }
                })
                .catch(error => {
                    console.warn('External ticker feeds unavailable:', error);
                    tickerExtras = [];
                });
        }

        function startSlideShow(durations = SLIDE_DURATIONS_MS) {
            const slides = Array.from(document.querySelectorAll('.slide'));
            if (slides.length === 0) {
                return;
            }

            let index = slides.findIndex(slide => slide.classList.contains('active'));
            if (index === -1) {
                index = 0;
                slides[0].classList.add('active');
            }

            if (slides.length === 1) {
                return;
            }

            const rotationDurations = Array.isArray(durations) && durations.length
                ? durations.map(value => {
                    const numeric = Number(value);
                    return Number.isFinite(numeric) && numeric > 0 ? numeric : 15000;
                })
                : [15000];

            function scheduleTransition(currentIndex) {
                const delay = rotationDurations[currentIndex % rotationDurations.length];
                setTimeout(() => {
                    const nextIndex = (currentIndex + 1) % slides.length;
                    slides.forEach((slide, idx) => {
                        slide.classList.toggle('active', idx === nextIndex);
                    });
                    scheduleTransition(nextIndex);
                }, delay);
            }

            scheduleTransition(index);
        }

        // Initialize with sample data
        function initializeDisplay(data) {
            const correctedData = correctDataNames(data);
            const standings = Array.isArray(correctedData.standings) ? correctedData.standings : [];
            const scorers = Array.isArray(correctedData.top_scorers) ? correctedData.top_scorers : [];
            const recentSource = uniqueByGameId(Array.isArray(correctedData.recent_results) ? correctedData.recent_results : []);
            const upcomingSource = uniqueByGameId(Array.isArray(correctedData.upcoming_games) ? correctedData.upcoming_games : []);
            const recentGames = filterRecentGames(recentSource);
            const upcomingGames = filterUpcomingGames(upcomingSource);

            currentRecentGames = recentGames;
            currentUpcomingGames = upcomingGames;

            renderStandings(standings);
            renderScorers(scorers);
            startResultsCarousel();
            startUpcomingCarousel();
            renderTicker(recentGames, upcomingGames, scorers, standings);

            // Update last updated timestamp
            if (data.timestamp) {
                const timestamp = new Date(data.timestamp);
                const lastUpdated = document.getElementById('lastUpdated');
                if (lastUpdated && !Number.isNaN(timestamp.getTime())) {
                    const now = new Date();
                    const diffMs = now - timestamp;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);

                    let timeAgo;
                    if (diffMins < 1) {
                        timeAgo = 'just now';
                    } else if (diffMins < 60) {
                        timeAgo = `${diffMins} min ago`;
                    } else if (diffHours < 24) {
                        timeAgo = `${diffHours} hr ago`;
                    } else {
                        timeAgo = timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                    lastUpdated.textContent = `Updated ${timeAgo}`;
                }
            }
        }

        // Load data from external source or use sample data
        function loadData() {
            const dataUrl = 'https://raw.githubusercontent.com/ThomasMcCrossin/aahlscraper/main/data/yodeck_display.json';
            const cached = loadCache();

            if (cached) {
                console.log('Loaded data from cache');
                initializeDisplay(cached);
            }

            fetch(dataUrl, { cache: 'no-store' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch data from GitHub');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Successfully loaded data from GitHub');
                    console.log('Data timestamp:', data.timestamp);
                    saveCache(data);
                    initializeDisplay(data);
                })
                .catch(error => {
                    console.warn('Could not load data from GitHub:', error);
                    if (cached) {
                        console.log('Using cached data after fetch failure');
                        return;
                    }
                    console.log('No cache available, using bundled sample data');
                    initializeDisplay(sampleData);
                });
        }

        // Kick off slide rotation and start the application
        loadTickerExtras();
        startSlideShow();
        loadData();

        // Yodeck lifecycle hooks (optional)
        if (window.parent && window.parent.YodeckAPI) {
            window.parent.YodeckAPI.onShown = function() {
                console.log('Display shown');
            };
            
            window.parent.YodeckAPI.onHidden = function() {
                console.log('Display hidden');
            };
        }
    </script>
</body>
</html>
